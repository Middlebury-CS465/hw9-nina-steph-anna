<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Text Fingerprinting</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>


    <style type="text/css">

    #tooltipSteph{
      position:absolute;
      width:150px;
      height:auto;
      padding:10px;
      background-color: white;
      border-radius:10px;
      box-shadow: 4px 4px 10px rgba(0,0,0,0.4);
      pointer-events: none;
    }

    #tooltipSteph p{
      margin:0;
      font-family: sans-serif;
      font-size:12px;
    }

    #tooltipSteph.hidden{
      display:none;
    }

    </style>
</head>
<body>
    <h1>Opiods in Massachusetts</h1>
    <h4> Nina Sonneborn and Steph Jordan and Anna Novak </h4>
    <p>This is a description of our project/an intro</p>
    <div>
        <p> Text above first vis </p>
    </div>
    <svg id="vis1"></svg>
    <div>
        <p> Text above second vis </p>
    </div>
    <svg id="vis2"></svg>
  <svg id="key"></svg>
    <!-- <div>
        <p> Text above third vis </p>
    </div> -->
    <!-- <svg id="vis3"></svg> -->
    <div id="tooltipSteph" class="hidden">

      <p>
        Name: <span id="nameSteph"></span><br />

        Population: <span id="popSteph"></span><br />
      </p>
    </div>
  <!-- <svg id="key"></svg> -->
    <script>
    const margins = {top:10, bottom:60, left:70, right:10};
    const width = 400;
    const height = 400;
    let key_height=450;
    let names=[];
    d3.csv("https://raw.githubusercontent.com/nsonneborn/ma-opioids-data/master/county_deaths.csv").then(function(county_data)
    {
      const names=[];
      const county_names=["Barnstable",
"Berkshire",
"Bristol",
"Dukes",
"Essex",
"Franklin",
"Hampden",
"Hampshire",
"Middlesex",
"Nantucket",
"Norfolk",
"Plymouth",
"Suffolk",
"Worcester"]
      const data= d3.nest()
        .key(function(d) { return d.County; })
        .map(county_data);
      for (i=0; i<county_names.length; i++){

        const name=county_names[i];
        const selected=data.get(name);

        const name_obj = {name:name, data:selected, color: null};
        names.push(name_obj)
      }
      function get_average(){

        let full=[];
        for (i=0; i<18; i++){
          let num=0;
          for (j=0; j<county_names.length; j++){
            num+=(+names[j].data[i]["DeathsPerCapita"])
          }
          let avgThisYear=num/county_names.length;
          selected={Year:(2000+i), DeathsPerCapita: avgThisYear};
          full.push(selected)
        }

        const name_obj = {name:"Average", data:full, color: null};
        names.push(name_obj)
      }
      get_average();
      //need to nest data such that we have all years for each county
      console.log(data)
      const svgSteph = d3.select("#vis2")
          .attr("width", width+ margins.right + margins.left)
          .attr("height", height+ margins.top + margins.bottom);

      const chartSteph = svgSteph.append("g")
      .attr("transform", `translate(${margins.left}, ${margins.top})`);

      const svg2 = d3.select("#key")
          .attr("width", width+ margins.right + margins.left)
          .attr("height", key_height);
      const key = svg2.append("g")
      .attr("transform", `translate(${5}, ${margins.top})`);

      var x_scale = d3.scaleLinear()
        .range([0,width])
        .domain([2000, 2017])

      var y_scale = d3.scaleLinear()
        .range([height, 0])
        .domain([0,0.0005]);

      let colorScale= d3.scaleOrdinal()
      .range(["red", "green", "blue", "orange", "yellow", "purple", "pink", "indigo","#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);

      const line = d3.line()
        .x(function(d){

          return x_scale(+d["Year"])}
        )
        .y(function(d){

          return y_scale(+d["DeathsPerCapita"])}
        )

        //current set
        let current_lines=chartSteph.selectAll(".namelines")
          .data(names, (d)=>d)


        //exit set
        current_lines.exit().remove();

        //enter set
        let new_lines=current_lines.enter()
              .append("path")
              .attr("class", "namelines")
              .on('mouseover', function(d){

                const tooltip=d3.select("#tooltipSteph");

                tooltip.classed("hidden", false);

                d3.select("#nameSteph").text(d.name);

                d3.select("#popSteph").text(+d.data[0]["Population"]);


                const coordinates = [d3.event.pageX, d3.event.pageY];

                tooltip.style("left", (coordinates[0]+25) + "px");
                tooltip.style("top", (coordinates[1]+25) + "px");


              })
              .on('mouseout', function(d){
                const tooltip=d3.select("#tooltipSteph");
                tooltip.classed("hidden", true);
              })



        current_lines=current_lines.merge(new_lines);

        current_lines.attr("d", function(d){

            return line(d.data);
        })
        .style("stroke", function(d,i){

          return colorScale(i)})
        .style("fill", "none")
        .attr('stroke-width', function(d) {
            if (d.name==="Average"){

              return 3;
            }
            else{

              return 1;
            }

         })

        //current set for key
        let currentKey=key.selectAll("rect")
        .data(names, (d)=>d);

        //exit set for key
        currentKey.exit().remove();

        //enter set for key
        let newKey=currentKey
        .enter()
        .append("rect")

        currentKey=currentKey.merge(newKey);

        currentKey.attr('x',0)
        .attr('y',(d,i)=>i*20)
        .attr('width', 60)
        .attr('height', 20)
        .style("fill", (d, i)=>colorScale(i)/*d3.schemeCategory20[i]*/);

        //current set for text
        let currentText=key.selectAll(".keytext")
        .data(names, (d)=>d);

        //exit set for text
        currentText.exit().remove();

        //enter set for text
        let newText=currentText
        .enter()
        .append("text")
        .attr("class", "keytext")
        .style("fill", "white");

        currentText=currentText.merge(newText);

        currentText.attr('x',0)
        .style("font-size", "0.8em")
        .attr('y',(d,i)=>(i*20)+12)
        .text((d)=>(d.name));


      // X axis
      chartSteph.append("g")
        .attr("transform", `translate(0, ${height})`)
        .call(d3.axisBottom(x_scale).tickFormat(d3.format("d")))



      // Y axis
      let yaxis=chartSteph.append("g")
        .attr("class", "yaxis")
        .call(d3.axisLeft(y_scale))

      // Add labels

      chartSteph.append("text")
        .attr("text-anchor", "middle")
        .attr("transform", `translate(${width/2}, ${height + margins.bottom})`)
        .text("Year");
      chartSteph.append("text")
        .attr("text-anchor", "middle")
        .attr("transform", `translate(${-(margins.left)*0.75}, ${height/2})rotate(-90)`)
        .text("Deaths by Overdose per Capita");


  });



    </script>
</body>
</html>
